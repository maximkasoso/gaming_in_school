<!DOCTYPE html>
<html>
<head>
    <title>Ballistic Chickens Deluxe</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB, #1E90FF);
            font-family: 'Comic Sans MS', cursive;
            touch-action: none;
        }
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #FF8C00;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s;
            pointer-events: auto;
        }
        button:hover {
            background-color: #FF6B00;
            transform: scale(1.05);
        }
        #message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 48px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="ui">
        <div>Chickens: <span id="chickenCount">20</span></div>
        <div>Score: <span id="score">0</span></div>
        <div>Level: <span id="level">1</span></div>
    </div>
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    <div id="controls">
        <button id="restartBtn">Restart Level</button>
        <button id="newGameBtn">New Game</button>
    </div>
    <div id="message"></div>

    <script>
        // Game constants
        const CHICKEN_RADIUS = 20;
        const PIG_RADIUS = 20;
        const WOOD_STRENGTH = 3;
        const ICE_STRENGTH = 1;
        const STONE_STRENGTH = 5;
        const LEVEL_WIDTH = 800;
        const LEVEL_HEIGHT = 500;
        const GROUND_HEIGHT = 480;
        const INITIAL_CHICKENS = 20;

        // Game setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chickenCountEl = document.getElementById('chickenCount');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const restartBtn = document.getElementById('restartBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const messageEl = document.getElementById('message');

        // Load textures
        const textures = {
            chicken: createChickenTexture(),
            pig: createPigTexture(),
            wood: createWoodTexture(),
            ice: createIceTexture(),
            stone: createStoneTexture(),
            ground: createGroundTexture(),
            slingshot: createSlingshotTexture(),
            explosion: createExplosionTexture(),
            pigKing: createPigKingTexture()
        };

        // Game state
        let gameState = {
            chickens: INITIAL_CHICKENS,
            score: 0,
            level: 1,
            launchedChickens: [],
            targets: [],
            obstacles: [],
            particles: [],
            slingshot: { x: 150, y: 400 },
            dragging: false,
            currentChicken: null,
            gameOver: false,
            levelComplete: false,
            lastTime: 0,
            deltaTime: 0
        };

        // Initialize game
        function initGame() {
            resetGameState();
            generateLevel();
            render();
            gameLoop(performance.now());
        }

        function resetGameState() {
            gameState.launchedChickens = [];
            gameState.targets = [];
            gameState.obstacles = [];
            gameState.particles = [];
            gameState.dragging = false;
            gameState.currentChicken = null;
            gameState.gameOver = false;
            gameState.levelComplete = false;
        }

        function generateLevel() {
            // Clear existing
            gameState.targets = [];
            gameState.obstacles = [];
            
            // Create targets (pigs)
            const pigCount = 3 + Math.floor(gameState.level * 1.5);
            for (let i = 0; i < pigCount; i++) {
                gameState.targets.push({
                    x: 550 + Math.random() * 200,
                    y: 300 + Math.random() * 150,
                    radius: PIG_RADIUS,
                    health: 1,
                    type: 'pig',
                    value: 100
                });
            }
            
            // Add a king pig every 3 levels
            if (gameState.level % 3 === 0) {
                gameState.targets.push({
                    x: 650,
                    y: 350,
                    radius: PIG_RADIUS * 1.5,
                    health: 3,
                    type: 'pigKing',
                    value: 500
                });
            }
            
            // Generate structures
            generateStructures();
        }
        
        function generateStructures() {
            const structureTypes = ['pyramid', 'tower', 'house', 'bridge', 'castle'];
            const structureCount = 2 + Math.floor(gameState.level / 2);
            
            for (let i = 0; i < structureCount; i++) {
                const type = structureTypes[Math.floor(Math.random() * structureTypes.length)];
                const x = 500 + Math.random() * 250;
                const y = 350 + Math.random() * 100;
                const size = 2 + Math.floor(gameState.level / 3);
                
                switch(type) {
                    case 'pyramid':
                        createPyramid(x, y, size);
                        break;
                    case 'tower':
                        createTower(x, y, size);
                        break;
                    case 'house':
                        createHouse(x, y);
                        break;
                    case 'bridge':
                        createBridge(x, y, size);
                        break;
                    case 'castle':
                        createCastle(x, y, size);
                        break;
                }
            }
        }
        
        function createPyramid(x, y, size) {
            const spacing = 45;
            const materials = ['wood', 'stone'];
            
            for (let row = 0; row < size; row++) {
                const cols = size - row;
                const material = materials[Math.floor(Math.random() * materials.length)];
                let strength;
                switch(material) {
                    case 'wood': strength = WOOD_STRENGTH; break;
                    case 'stone': strength = STONE_STRENGTH; break;
                }
                
                for (let col = 0; col < cols; col++) {
                    gameState.obstacles.push({
                        x: x + (col - cols/2 + 0.5) * spacing,
                        y: y + row * spacing * 0.8,
                        width: 40,
                        height: 40,
                        health: strength,
                        type: material,
                        rotation: 0,
                        isDebris: false
                    });
                }
            }
        }
        
        function createTower(x, y, height) {
            const spacing = 45;
            
            for (let i = 0; i < height; i++) {
                const material = i % 2 === 0 ? 'stone' : 'wood';
                let strength;
                switch(material) {
                    case 'wood': strength = WOOD_STRENGTH; break;
                    case 'stone': strength = STONE_STRENGTH; break;
                }
                
                gameState.obstacles.push({
                    x: x,
                    y: y - i * spacing * 0.8,
                    width: 40 + i * 2,
                    height: 40,
                    health: strength,
                    type: material,
                    rotation: i % 2 === 0 ? Math.PI/4 : 0,
                    isDebris: false
                });
            }
        }
        
        function createHouse(x, y) {
            // Base
            gameState.obstacles.push({
                x: x,
                y: y,
                width: 120,
                height: 80,
                health: WOOD_STRENGTH,
                type: 'wood',
                rotation: 0,
                isDebris: false
            });
            
            // Roof (triangle)
            gameState.obstacles.push({
                x: x,
                y: y - 60,
                width: 140,
                height: 80,
                health: WOOD_STRENGTH,
                type: 'wood',
                rotation: 0,
                isTriangle: true,
                isDebris: false
            });
            
            // Add a pig inside
            gameState.targets.push({
                x: x,
                y: y - 20,
                radius: PIG_RADIUS,
                health: 1,
                type: 'pig',
                value: 100
            });
        }
        
        function createBridge(x, y, length) {
            const spacing = 50;
            
            // Pillars
            gameState.obstacles.push({
                x: x - length * spacing/2,
                y: y + 40,
                width: 30,
                height: 80,
                health: STONE_STRENGTH,
                type: 'stone',
                rotation: 0,
                isDebris: false
            });
            
            gameState.obstacles.push({
                x: x + length * spacing/2,
                y: y + 40,
                width: 30,
                height: 80,
                health: STONE_STRENGTH,
                type: 'stone',
                rotation: 0,
                isDebris: false
            });
            
            // Bridge planks
            for (let i = 0; i < length; i++) {
                gameState.obstacles.push({
                    x: x + (i - length/2 + 0.5) * spacing,
                    y: y,
                    width: 40,
                    height: 20,
                    health: WOOD_STRENGTH,
                    type: 'wood',
                    rotation: 0,
                    isDebris: false
                });
            }
            
            // Pigs on bridge
            for (let i = 1; i < length; i += 2) {
                gameState.targets.push({
                    x: x + (i - length/2 + 0.5) * spacing,
                    y: y - 30,
                    radius: PIG_RADIUS,
                    health: 1,
                    type: 'pig',
                    value: 100
                });
            }
        }
        
        function createCastle(x, y, size) {
            // Base
            gameState.obstacles.push({
                x: x,
                y: y,
                width: 200,
                height: 100,
                health: STONE_STRENGTH * 2,
                type: 'stone',
                rotation: 0,
                isDebris: false
            });
            
            // Towers
            gameState.obstacles.push({
                x: x - 80,
                y: y - 60,
                width: 50,
                height: 120,
                health: STONE_STRENGTH * 2,
                type: 'stone',
                rotation: 0,
                isDebris: false
            });
            
            gameState.obstacles.push({
                x: x + 80,
                y: y - 60,
                width: 50,
                height: 120,
                health: STONE_STRENGTH * 2,
                type: 'stone',
                rotation: 0,
                isDebris: false
            });
            
            // Battlements
            for (let i = 0; i < 5; i++) {
                gameState.obstacles.push({
                    x: x - 100 + i * 40,
                    y: y - 100,
                    width: 30,
                    height: 30,
                    health: STONE_STRENGTH,
                    type: 'stone',
                    rotation: 0,
                    isDebris: false
                });
            }
            
            // King pig in castle
            gameState.targets.push({
                x: x,
                y: y - 40,
                radius: PIG_RADIUS * 1.5,
                health: 3,
                type: 'pigKing',
                value: 500
            });
            
            // Regular pigs as guards
            gameState.targets.push({
                x: x - 60,
                y: y - 40,
                radius: PIG_RADIUS,
                health: 1,
                type: 'pig',
                value: 100
            });
            
            gameState.targets.push({
                x: x + 60,
                y: y - 40,
                radius: PIG_RADIUS,
                health: 1,
                type: 'pig',
                value: 100
            });
        }

        // Texture creation functions
        function createChickenTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = CHICKEN_RADIUS * 2;
            canvas.height = CHICKEN_RADIUS * 2;
            const ctx = canvas.getContext('2d');
            
            // Body
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(CHICKEN_RADIUS, CHICKEN_RADIUS, CHICKEN_RADIUS, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(CHICKEN_RADIUS - 8, CHICKEN_RADIUS - 5, 5, 0, Math.PI * 2);
            ctx.arc(CHICKEN_RADIUS + 8, CHICKEN_RADIUS - 5, 5, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(CHICKEN_RADIUS - 8, CHICKEN_RADIUS - 5, 2, 0, Math.PI * 2);
            ctx.arc(CHICKEN_RADIUS + 8, CHICKEN_RADIUS - 5, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Beak
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.moveTo(CHICKEN_RADIUS - 5, CHICKEN_RADIUS + 5);
            ctx.lineTo(CHICKEN_RADIUS + 5, CHICKEN_RADIUS + 5);
            ctx.lineTo(CHICKEN_RADIUS, CHICKEN_RADIUS + 15);
            ctx.fill();
            
            // Comb
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.moveTo(CHICKEN_RADIUS - 10, CHICKEN_RADIUS - 15);
            ctx.lineTo(CHICKEN_RADIUS, CHICKEN_RADIUS - 25);
            ctx.lineTo(CHICKEN_RADIUS + 10, CHICKEN_RADIUS - 15);
            ctx.fill();
            
            return canvas;
        }
        
        function createPigTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = PIG_RADIUS * 2;
            canvas.height = PIG_RADIUS * 2;
            const ctx = canvas.getContext('2d');
            
            // Body
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS, PIG_RADIUS, PIG_RADIUS, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS - 8, PIG_RADIUS - 5, 5, 0, Math.PI * 2);
            ctx.arc(PIG_RADIUS + 8, PIG_RADIUS - 5, 5, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS - 8, PIG_RADIUS - 5, 2, 0, Math.PI * 2);
            ctx.arc(PIG_RADIUS + 8, PIG_RADIUS - 5, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Nose
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS, PIG_RADIUS + 5, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Nostrils
            ctx.fillStyle = '#145214';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS - 3, PIG_RADIUS + 5, 1, 0, Math.PI * 2);
            ctx.arc(PIG_RADIUS + 3, PIG_RADIUS + 5, 1, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }
        
        function createPigKingTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = PIG_RADIUS * 3;
            canvas.height = PIG_RADIUS * 3;
            const ctx = canvas.getContext('2d');
            
            // Body
            ctx.fillStyle = '#FF1493';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5, PIG_RADIUS * 1.5, PIG_RADIUS * 1.5, 0, Math.PI * 2);
            ctx.fill();
            
            // Eyes
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5 - 12, PIG_RADIUS * 1.5 - 8, 8, 0, Math.PI * 2);
            ctx.arc(PIG_RADIUS * 1.5 + 12, PIG_RADIUS * 1.5 - 8, 8, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5 - 12, PIG_RADIUS * 1.5 - 8, 3, 0, Math.PI * 2);
            ctx.arc(PIG_RADIUS * 1.5 + 12, PIG_RADIUS * 1.5 - 8, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Nose
            ctx.fillStyle = '#800080';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5, PIG_RADIUS * 1.5 + 8, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Nostrils
            ctx.fillStyle = '#4B0082';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5 - 4, PIG_RADIUS * 1.5 + 8, 1.5, 0, Math.PI * 2);
            ctx.arc(PIG_RADIUS * 1.5 + 4, PIG_RADIUS * 1.5 + 8, 1.5, 0, Math.PI * 2);
            ctx.fill();
            
            // Crown
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.moveTo(PIG_RADIUS * 1.5 - 20, PIG_RADIUS * 1.5 - 20);
            ctx.lineTo(PIG_RADIUS * 1.5 - 10, PIG_RADIUS * 1.5 - 30);
            ctx.lineTo(PIG_RADIUS * 1.5, PIG_RADIUS * 1.5 - 25);
            ctx.lineTo(PIG_RADIUS * 1.5 + 10, PIG_RADIUS * 1.5 - 30);
            ctx.lineTo(PIG_RADIUS * 1.5 + 20, PIG_RADIUS * 1.5 - 20);
            ctx.closePath();
            ctx.fill();
            
            // Jewels
            ctx.fillStyle = '#FF0000';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5, PIG_RADIUS * 1.5 - 28, 3, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#00FF00';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5 - 7, PIG_RADIUS * 1.5 - 27, 2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#0000FF';
            ctx.beginPath();
            ctx.arc(PIG_RADIUS * 1.5 + 7, PIG_RADIUS * 1.5 - 27, 2, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }
        
        function createWoodTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 60;
            canvas.height = 60;
            const ctx = canvas.getContext('2d');
            
            // Wood base
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, 0, 60, 60);
            
            // Wood grain
            ctx.strokeStyle = '#5D2906';
            ctx.lineWidth = 2;
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * 15);
                ctx.bezierCurveTo(
                    20, i * 15 + Math.random() * 10 - 5,
                    40, i * 15 + Math.random() * 10 - 5,
                    60, i * 15
                );
                ctx.stroke();
            }
            
            // Knots
            ctx.fillStyle = '#5D2906';
            ctx.beginPath();
            ctx.arc(30, 30, 5 + Math.random() * 3, 0, Math.PI * 2);
            ctx.fill();
            
            return canvas;
        }
        
        function createIceTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 60;
            canvas.height = 60;
            const ctx = canvas.getContext('2d');
            
            // Ice base
            ctx.fillStyle = '#ADD8E6';
            ctx.fillRect(0, 0, 60, 60);
            
            // Cracks
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.lineWidth = 1;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(Math.random() * 60, Math.random() * 60);
                ctx.lineTo(Math.random() * 60, Math.random() * 60);
                ctx.stroke();
            }
            
            // Highlights
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(30, 0);
            ctx.lineTo(0, 30);
            ctx.fill();
            
            return canvas;
        }
        
        function createStoneTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 60;
            canvas.height = 60;
            const ctx = canvas.getContext('2d');
            
            // Stone base
            ctx.fillStyle = '#808080';
            ctx.fillRect(0, 0, 60, 60);
            
            // Texture
            for (let i = 0; i < 100; i++) {
                const x = Math.random() * 60;
                const y = Math.random() * 60;
                const size = Math.random() * 3 + 1;
                const shade = 150 + Math.random() * 105;
                ctx.fillStyle = `rgb(${shade}, ${shade}, ${shade})`;
                ctx.fillRect(x, y, size, size);
            }
            
            return canvas;
        }
        
        function createGroundTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = LEVEL_WIDTH;
            canvas.height = LEVEL_HEIGHT - GROUND_HEIGHT;
            const ctx = canvas.getContext('2d');
            
            // Grass
            ctx.fillStyle = '#4a3520';
            ctx.fillRect(0, 0, LEVEL_WIDTH, LEVEL_HEIGHT - GROUND_HEIGHT);
            
            // Grass blades
            ctx.strokeStyle = '#3a5c0a';
            ctx.lineWidth = 2;
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * LEVEL_WIDTH;
                const height = Math.random() * 10 + 5;
                ctx.beginPath();
                ctx.moveTo(x, LEVEL_HEIGHT - GROUND_HEIGHT);
                ctx.quadraticCurveTo(
                    x + Math.random() * 10 - 5, 
                    LEVEL_HEIGHT - GROUND_HEIGHT - height,
                    x + Math.random() * 10 - 5,
                    LEVEL_HEIGHT - GROUND_HEIGHT - height
                );
                ctx.stroke();
            }
            
            return canvas;
        }
        
        function createSlingshotTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            // Poles
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 10;
            ctx.beginPath();
            ctx.moveTo(30, 80);
            ctx.lineTo(50, 40);
            ctx.lineTo(70, 80);
            ctx.stroke();
            
            // Rubber bands
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(30, 80);
            ctx.lineTo(50, 60);
            ctx.moveTo(70, 80);
            ctx.lineTo(50, 60);
            ctx.stroke();
            
            return canvas;
        }
        
        function createExplosionTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 60;
            canvas.height = 60;
            const ctx = canvas.getContext('2d');
            
            // Explosion center
            const gradient = ctx.createRadialGradient(30, 30, 5, 30, 30, 30);
            gradient.addColorStop(0, 'rgba(255, 200, 0, 1)');
            gradient.addColorStop(0.5, 'rgba(255, 100, 0, 0.7)');
            gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 60, 60);
            
            return canvas;
        }

        // Game mechanics
        function launchChicken(dx, dy) {
            if (gameState.chickens <= 0) return;
            
            gameState.chickens--;
            chickenCountEl.textContent = gameState.chickens;
            
            gameState.launchedChickens.push({
                x: gameState.slingshot.x,
                y: gameState.slingshot.y,
                dx: dx * 0.2,
                dy: dy * 0.2,
                radius: CHICKEN_RADIUS,
                rotation: 0
            });
        }
        
        function createParticles(x, y, count, color, speed) {
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * speed;
                
                gameState.particles.push({
                    x: x,
                    y: y,
                    dx: Math.cos(angle) * velocity,
                    dy: Math.sin(angle) * velocity,
                    radius: Math.random() * 3 + 1,
                    color: color,
                    life: 1,
                    decay: Math.random() * 0.02 + 0.01
                });
            }
        }
        
        function createDebris(x, y, width, height, type) {
            const pieceCount = 3 + Math.floor(Math.random() * 3);
            const colors = {
                wood: ['#8B4513', '#5D2906', '#A0522D'],
                ice: ['#ADD8E6', '#87CEEB', '#E0FFFF'],
                stone: ['#808080', '#A9A9A9', '#696969']
            };
            
            for (let i = 0; i < pieceCount; i++) {
                const pieceWidth = width / 2;
                const pieceHeight = height / 2;
                
                gameState.obstacles.push({
                    x: x + Math.random() * width - width/2,
                    y: y + Math.random() * height - height/2,
                    width: pieceWidth,
                    height: pieceHeight,
                    dx: (Math.random() - 0.5) * 5,
                    dy: (Math.random() - 0.5) * 5,
                    health: 1,
                    type: type,
                    rotation: Math.random() * Math.PI * 2,
                    rotationSpeed: (Math.random() - 0.5) * 0.1,
                    isDebris: true
                });
            }
        }

        // Update game state
        function update(timestamp) {
            if (!gameState.lastTime) {
                gameState.lastTime = timestamp;
            }
            gameState.deltaTime = (timestamp - gameState.lastTime) / 1000;
            gameState.lastTime = timestamp;
            
            // Update chickens
            for (let i = gameState.launchedChickens.length - 1; i >= 0; i--) {
                const chicken = gameState.launchedChickens[i];
                
                // Apply gravity
                chicken.dy += 15 * gameState.deltaTime;
                
                // Update position
                chicken.x += chicken.dx * gameState.deltaTime * 60;
                chicken.y += chicken.dy * gameState.deltaTime * 60;
                chicken.rotation = Math.atan2(chicken.dy, chicken.dx);
                
                // Check boundaries
                if (chicken.x < -50 || chicken.x > LEVEL_WIDTH + 50 || chicken.y > LEVEL_HEIGHT + 50) {
                    gameState.launchedChickens.splice(i, 1);
                    continue;
                }
                
                // Check collisions with targets
                for (let j = gameState.targets.length - 1; j >= 0; j--) {
                    const target = gameState.targets[j];
                    const dist = Math.sqrt(
                        Math.pow(chicken.x - target.x, 2) + 
                        Math.pow(chicken.y - target.y, 2)
                    );
                    
                    if (dist < chicken.radius + target.radius) {
                        // Create explosion
                        createParticles(target.x, target.y, 15, target.type === 'pigKing' ? '#FF1493' : '#FF6B6B', 8);
                        createParticles(target.x, target.y, 10, '#FFD700', 5);
                        
                        // Damage target
                        target.health--;
                        
                        if (target.health <= 0) {
                            // Remove target
                            gameState.targets.splice(j, 1);
                            gameState.score += target.value * gameState.level;
                            scoreEl.textContent = gameState.score;
                            
                            // Check if all targets are gone
                            if (gameState.targets.length === 0 && !gameState.levelComplete) {
                                gameState.levelComplete = true;
                                showMessage("Level Complete!");
                                setTimeout(() => {
                                    advanceLevel();
                                }, 2000);
                            }
                        }
                        
                        // Remove chicken
                        gameState.launchedChickens.splice(i, 1);
                        break;
                    }
                }
                
                // Check collisions with obstacles
                for (let j = gameState.obstacles.length - 1; j >= 0; j--) {
                    const obstacle = gameState.obstacles[j];
                    
                    if (obstacle.isTriangle) {
                        // Triangle collision (for roofs)
                        const dx = chicken.x - obstacle.x;
                        const dy = chicken.y - (obstacle.y - obstacle.height/2);
                        
                        if (Math.abs(dx) < obstacle.width/2 && dy > -obstacle.height && dy < 0) {
                            if (Math.abs(dy) > Math.abs(dx) * 0.5) {
                                // Damage obstacle
                                obstacle.health--;
                                
                                // Create particles based on material
                                let particleColor;
                                switch(obstacle.type) {
                                    case 'wood': particleColor = '#8B4513'; break;
                                    case 'ice': particleColor = '#ADD8E6'; break;
                                    case 'stone': particleColor = '#808080'; break;
                                }
                                createParticles(chicken.x, chicken.y, 10, particleColor, 5);
                                
                                if (obstacle.health <= 0) {
                                    // Create debris
                                    createDebris(obstacle.x, obstacle.y, obstacle.width, obstacle.height, obstacle.type);
                                    
                                    // Remove obstacle
                                    gameState.obstacles.splice(j, 1);
                                    gameState.score += 50 * gameState.level;
                                    scoreEl.textContent = gameState.score;
                                }
                                
                                // Remove chicken
                                gameState.launchedChickens.splice(i, 1);
                                break;
                            }
                        }
                    } else {
                        // Rotated rectangle collision
                        const dx = chicken.x - obstacle.x;
                        const dy = chicken.y - obstacle.y;
                        
                        // Rotate the chicken position to align with the obstacle's rotation
                        const rotatedX = dx * Math.cos(-obstacle.rotation) - dy * Math.sin(-obstacle.rotation);
                        const rotatedY = dx * Math.sin(-obstacle.rotation) + dy * Math.cos(-obstacle.rotation);
                        
                        if (
                            Math.abs(rotatedX) < obstacle.width/2 + chicken.radius &&
                            Math.abs(rotatedY) < obstacle.height/2 + chicken.radius
                        ) {
                            // Damage obstacle
                            obstacle.health--;
                            
                            // Create particles based on material
                            let particleColor;
                            switch(obstacle.type) {
                                case 'wood': particleColor = '#8B4513'; break;
                                case 'ice': particleColor = '#ADD8E6'; break;
                                case 'stone': particleColor = '#808080'; break;
                            }
                            createParticles(chicken.x, chicken.y, 10, particleColor, 5);
                            
                            if (obstacle.health <= 0) {
                                // Create debris
                                createDebris(obstacle.x, obstacle.y, obstacle.width, obstacle.height, obstacle.type);
                                
                                // Remove obstacle
                                gameState.obstacles.splice(j, 1);
                                gameState.score += 50 * gameState.level;
                                scoreEl.textContent = gameState.score;
                            }
                            
                            // Remove chicken
                            gameState.launchedChickens.splice(i, 1);
                            break;
                        }
                    }
                }
            }
            
            // Update obstacles (for debris)
            for (let i = gameState.obstacles.length - 1; i >= 0; i--) {
                const obstacle = gameState.obstacles[i];
                
                if (obstacle.isDebris) {
                    // Apply gravity
                    obstacle.dy += 10 * gameState.deltaTime;
                    
                    // Update position
                    obstacle.x += obstacle.dx
